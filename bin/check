#!/usr/bin/env bash

set -e

if [ "$TERM_PROGRAM" == "vscode" ]; then
    clear
fi

git stash

set +e

end() {
    set -e
    git stash pop --quiet
}

try() {
    echo "$" $*
    $*

    exit_code=$?
    if [ $exit_code -ne 0 ]; then
        end
        exit $exit_code
    fi
}

try cargo test
try cargo clippy --all-targets
try cargo fmt --all -- --check

export RUSTFLAGS="-D warnings"
try cargo build
unset RUSTFLAGS

end
