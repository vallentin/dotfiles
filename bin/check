#!/usr/bin/env bash

set -e
vscode-clear

old=$(git rev-parse --quiet --verify refs/stash || true)

git stash --quiet
# git stash --include-untracked --quiet

new=$(git rev-parse --quiet --verify refs/stash)

end() {
    set -e

    if [ "$old" != "$new" ]; then
        git stash pop --quiet
    fi
}

try() {
    echo "$" $*
    $*

    exit_code=$?
    if [ $exit_code -ne 0 ]; then
        end
        exit $exit_code
    fi
}

set +e

try cargo test
try cargo clippy --all-targets
try cargo fmt --all -- --check

export RUSTFLAGS="-D warnings"
try cargo build
unset RUSTFLAGS

end
