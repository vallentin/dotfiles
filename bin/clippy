#!/usr/bin/env bash

set -e
vscode-clear

deny=()

while [[ $# -gt 0 ]]; do
    lint="$1"

    case $lint in
        p|pedantic)
        shift
        deny+=("clippy::pedantic")
        ;;

        n|nursery)
        shift
        deny+=("clippy::nursery")
        ;;

        c|cargo)
        shift
        deny+=("clippy::cargo")
        ;;

        +)
        shift
        deny+=("clippy::pedantic" "clippy::nursery")
        ;;

        --features)
        shift
        features="$1"
        shift
        ;;

        --)
        shift
        break
        ;;

        *)
        deny+=("$lint")
        shift
        ;;
    esac
done

if [[ ${deny[@]} ]]; then
    deny=$(printf -- "-D %s " "${deny[@]}")
fi

if [ ! -z "$features" ]; then
    features="--features $features"
fi

# Issue: https://github.com/rust-lang/rust-clippy/issues/4612
# find -name "*.rs" -exec touch "{}" +
find -name "*.rs" -not -path "./target/*" -exec touch "{}" +

cargo clippy --all-targets $features -- $deny
